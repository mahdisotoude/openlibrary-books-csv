<!doctype html>
<html lang="fa" dir="rtl">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>جستجوی کتاب (OpenLibrary)</title>
    <style>
      body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; max-width: 900px; margin: 40px auto; padding: 0 16px; }
      h1 { margin: 0 0 16px; }
      .row { display: flex; gap: 8px; align-items: center; }
      input { flex: 1; padding: 10px 12px; font-size: 16px; }
      button { padding: 10px 14px; font-size: 16px; cursor: pointer; }
      #status { margin-top: 12px; }
      .grid { margin-top: 12px; display: grid; gap: 10px; }
      .card { border: 1px solid #ddd; border-radius: 12px; padding: 12px; }
      .title { font-weight: 700; }
      .meta { opacity: 0.8; font-size: 14px; margin-top: 6px; }
      .error { color: #b00020; }
    </style>
  </head>

  <body>
    <h1>جستجوی کتاب</h1>

    <div class="row">
      <input id="q" type="text" placeholder="اسم کتاب را وارد کنید (مثلاً: harry potter)" />
      <button id="btn">جستجو</button>
    </div>

    <div id="status"></div>
    <div id="results" class="grid"></div>

    <script>
      const API_URL = "https://openlibrary.org/search.json";
      const fields = "title,author_name,first_publish_year,edition_count";
      const limit = 20;

      const $q = document.getElementById("q");
      const $btn = document.getElementById("btn");
      const $status = document.getElementById("status");
      const $results = document.getElementById("results");

      function setStatus(text, isError = false) {
        $status.textContent = text || "";
        $status.className = isError ? "error" : "";
      }

      function escapeHtml(s) {
        return (s ?? "").toString()
          .replaceAll("&", "&amp;")
          .replaceAll("<", "&lt;")
          .replaceAll(">", "&gt;")
          .replaceAll('"', "&quot;")
          .replaceAll("'", "&#039;");
      }

      async function searchBooks() {
        const q = $q.value.trim();
        if (!q) {
          setStatus("لطفاً یک عبارت برای جستجو وارد کنید.", true);
          $results.innerHTML = "";
          return;
        }

        setStatus("در حال دریافت نتایج...");
        $results.innerHTML = "";

        const params = new URLSearchParams({
          q,
          fields,
          limit: String(limit),
        });

        try {
          const res = await fetch(`${API_URL}?${params.toString()}`);
          if (!res.ok) throw new Error(`HTTP ${res.status}`);

          const data = await res.json();
          const docs = Array.isArray(data?.docs) ? data.docs : [];

          if (docs.length === 0) {
            setStatus("نتیجه‌ای پیدا نشد.");
            return;
          }

          setStatus(`تعداد نتایج: ${docs.length}`);

          const html = docs.map((d) => {
            const title = escapeHtml(d?.title || "(بدون عنوان)");
            const author = escapeHtml(d?.author_name?.[0] || "-");
            const year = escapeHtml(d?.first_publish_year ?? "-");
            const editions = escapeHtml(d?.edition_count ?? "-");

            return `
              <div class="card">
                <div class="title">${title}</div>
                <div class="meta">نویسنده: ${author}</div>
                <div class="meta">سال انتشار: ${year} | تعداد ادیشن: ${editions}</div>
              </div>
            `;
          }).join("");

          $results.innerHTML = html;
        } catch (err) {
          console.error(err);
          setStatus("خطا در ارسال درخواست. (اگر CORS دیدی، با سرور لوکال اجرا کن)", true);
        }
      }

      $btn.addEventListener("click", searchBooks);
      $q.addEventListener("keydown", (e) => {
        if (e.key === "Enter") searchBooks();
      });
    </script>
  </body>
</html>
